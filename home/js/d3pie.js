/*!
 * d3pie
 * @author Ben Keen
 * @version 0.1.9
 * @date June 17th, 2015
 * @repo http://github.com/benkeen/d3pie
*/ !function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.d3pie=e(t)}(this,function(){var t="d3pie",e=0,n={header:{title:{text:"",color:"#333333",fontSize:18,font:"arial"},subtitle:{text:"",color:"#666666",fontSize:14,font:"arial"},location:"top-center",titleSubtitlePadding:8},footer:{text:"",color:"#666666",fontSize:14,font:"arial",location:"left"},size:{canvasHeight:500,canvasWidth:500,pieInnerRadius:"0%",pieOuterRadius:null},data:{sortOrder:"none",ignoreSmallSegments:{enabled:!1,valueType:"percentage",value:null},smallSegmentGrouping:{enabled:!1,value:1,valueType:"percentage",label:"Other",color:"#cccccc"},content:[]},labels:{outer:{format:"label",hideWhenLessThanPercentage:null,pieDistance:30},inner:{format:"percentage",hideWhenLessThanPercentage:null},mainLabel:{color:"#333333",font:"arial",fontSize:10},percentage:{color:"#dddddd",font:"arial",fontSize:10,decimalPlaces:0},value:{color:"#cccc44",font:"arial",fontSize:10},lines:{enabled:!0,style:"curved",color:"segment"},truncation:{enabled:!1,truncateLength:30},formatter:null},effects:{load:{effect:"default",speed:1e3},pullOutSegmentOnClick:{effect:"bounce",speed:300,size:10},highlightSegmentOnMouseover:!0,highlightLuminosity:-.2},tooltips:{enabled:!1,type:"placeholder",string:"",placeholderParser:null,styles:{fadeInSpeed:250,backgroundColor:"#000000",backgroundOpacity:.5,color:"#efefef",borderRadius:2,font:"arial",fontSize:10,padding:4}},misc:{colors:{background:null,segments:["#2484c1","#65a620","#7b6888","#a05d56","#961a1a","#d8d23a","#e98125","#d0743c","#635222","#6ada6a","#0c6197","#7d9058","#207f33","#44b9b0","#bca44a","#e4a14b","#a3acb2","#8cc3e9","#69a6f9","#5b388f","#546e91","#8bde95","#d2ab58","#273c71","#98bf6e","#4daa4b","#98abc5","#cc1010","#31383b","#006391","#c2643f","#b0a474","#a5a39c","#a9c2bc","#22af8c","#7fcecf","#987ac6","#3d3b87","#b77b1c","#c9c2b6","#807ece","#8db27c","#be66a2","#9ed3c6","#00644b","#005064","#77979f","#77e079","#9c73ab","#1f79a7"],segmentStroke:"#ffffff"},gradient:{enabled:!1,percentage:95,color:"#000000"},canvasPadding:{top:5,right:5,bottom:5,left:5},pieCenterOffset:{x:0,y:0},cssPrefix:null},callbacks:{onload:null,onMouseoverSegment:null,onMouseoutSegment:null,onClickSegment:null}},o={initialCheck:function(t){var e=t.cssPrefix,n=t.element,o=t.options;if(!window.d3||!window.d3.hasOwnProperty("version"))return console.error("d3pie error: d3 is not available"),!1;if(!(n instanceof HTMLElement||n instanceof SVGElement))return console.error("d3pie error: the first d3pie() param must be a valid DOM element (not jQuery) or a ID string."),!1;if(!/[a-zA-Z][a-zA-Z0-9_-]*$/.test(e))return console.error("d3pie error: invalid options.misc.cssPrefix"),!1;if(!i.isArray(o.data.content))return console.error("d3pie error: invalid config structure: missing data.content property."),!1;if(0===o.data.content.length)return console.error("d3pie error: no data supplied."),!1;for(var a=[],s=0;s<o.data.content.length;s++){if("number"!=typeof o.data.content[s].value||isNaN(o.data.content[s].value)){console.log("not valid: ",o.data.content[s]);continue}if(o.data.content[s].value<=0){console.log("not valid - should have positive value: ",o.data.content[s]);continue}a.push(o.data.content[s])}return t.options.data.content=a,!0}},i={addSVGSpace:function(t){var e=t.element,n=t.options.size.canvasWidth,o=t.options.size.canvasHeight,i=t.options.misc.colors.background,a=d3.select(e).append("svg:svg").attr("width",n).attr("height",o);return"transparent"!==i&&a.style("background-color",function(){return i}),a},whenIdExists:function(t,e){var n=1,o=setInterval(function(){document.getElementById(t)&&(clearInterval(o),e()),n>1e3&&clearInterval(o),n++},1)},whenElementsExist:function(t,e){var n=1,o=setInterval(function(){for(var i=!0,a=0;a<t.length;a++)if(!document.getElementById(t[a])){i=!1;break}i&&(clearInterval(o),e()),n>1e3&&clearInterval(o),n++},1)},shuffleArray:function(t){for(var e,n,o=t.length;0!==o;)n=Math.floor(Math.random()*o),o-=1,e=t[o],t[o]=t[n],t[n]=e;return t},processObj:function(t,e,n){return"string"==typeof e?i.processObj(t,e.split("."),n):1===e.length&&void 0!==n?(t[e[0]]=n,t[e[0]]):0===e.length?t:i.processObj(t[e[0]],e.slice(1),n)},getDimensions:function(t){var e=document.getElementById(t),n=0,o=0;if(e){var i=e.getBBox();n=i.width,o=i.height}else console.log("error: getDimensions() "+t+" not found.");return{w:n,h:o}},rectIntersect:function(t,e){return!(e.x>t.x+t.w||e.x+e.w<t.x||e.y+e.h<t.y||e.y>t.y+t.h)},getColorShade:function(t,e){(t=String(t).replace(/[^0-9a-f]/gi,"")).length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;for(var n="#",o=0;o<3;o++){var i=parseInt(t.substr(2*o,2),16);n+=("00"+(i=Math.round(Math.min(Math.max(0,i+i*e),255)).toString(16))).substr(i.length)}return n},initSegmentColors:function(t){for(var e=t.options.data.content,n=t.options.misc.colors.segments,o=[],i=0;i<e.length;i++)e[i].hasOwnProperty("color")?o.push(e[i].color):o.push(n[i]);return o},applySmallSegmentGrouping:function(t,e){"percentage"===e.valueType&&(n=s.getTotalPieSize(t));for(var n,o=[],i=[],a=0,r=0;r<t.length;r++)if("percentage"===e.valueType){if(t[r].value/n*100<=e.value){i.push(t[r]),a+=t[r].value;continue}t[r].isGrouped=!1,o.push(t[r])}else{if(t[r].value<=e.value){i.push(t[r]),a+=t[r].value;continue}t[r].isGrouped=!1,o.push(t[r])}return i.length&&o.push({color:e.color,label:e.label,value:a,isGrouped:!0,groupedData:i}),o},showPoint:function(t,e,n){t.append("circle").attr("cx",e).attr("cy",n).attr("r",2).style("fill","black")},isFunction:function(t){return t&&"[object Function]"===({}).toString.call(t)},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)}},a=function(){var t,e,n,o,i,s,r=arguments[0]||{},l=1,c=arguments.length,u=!1,p=Object.prototype.toString,f=Object.prototype.hasOwnProperty,g={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},h={isFunction:function(t){return"function"===h.type(t)},isArray:Array.isArray||function(t){return"array"===h.type(t)},isWindow:function(t){return null!==t&&t===t.window},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},type:function(t){return null===t?String(t):g[p.call(t)]||"object"},isPlainObject:function(t){var e;if(!t||"object"!==h.type(t)||t.nodeType)return!1;try{if(t.constructor&&!f.call(t,"constructor")&&!f.call(t.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}for(e in t);return void 0===e||f.call(t,e)}};for("boolean"==typeof r&&(u=r,r=arguments[1]||{},l=2),"object"==typeof r||h.isFunction(r)||(r={}),c===l&&(r=this,--l);l<c;l++)if(null!==(t=arguments[l]))for(e in t)n=r[e],r!==(o=t[e])&&(u&&o&&(h.isPlainObject(o)||(i=h.isArray(o)))?(i?(i=!1,s=n&&h.isArray(n)?n:[]):s=n&&h.isPlainObject(n)?n:{},r[e]=a(u,s,o)):void 0!==o&&(r[e]=o));return r},s={toRadians:function(t){return t*(Math.PI/180)},toDegrees:function(t){return t*(180/Math.PI)},computePieRadius:function(t){var e,n,o=t.options.size,i=t.options.misc.canvasPadding,a=o.canvasWidth-i.left-i.right,s=o.canvasHeight-i.top-i.bottom;"pie-center"!==t.options.header.location&&(s-=t.textComponents.headerHeight),t.textComponents.footer.exists&&(s-=t.textComponents.footer.h),s=s<0?0:s;var r=(a<s?a:s)/3;if(null!==o.pieOuterRadius){if(/%/.test(o.pieOuterRadius)){n=(n=(n=parseInt(o.pieOuterRadius.replace(/[\D]/,""),10))>99?99:n)<0?0:n;var l=a<s?a:s;if("none"!==t.options.labels.outer.format){var c=2*parseInt(t.options.labels.outer.pieDistance,10);l-c>0&&(l-=c)}r=Math.floor(l/100*n)/2}else r=parseInt(o.pieOuterRadius,10)}e=/%/.test(o.pieInnerRadius)?Math.floor(r/100*(n=(n=(n=parseInt(o.pieInnerRadius.replace(/[\D]/,""),10))>99?99:n)<0?0:n)):parseInt(o.pieInnerRadius,10),t.innerRadius=e,t.outerRadius=r},getTotalPieSize:function(t){for(var e=0,n=0;n<t.length;n++)e+=t[n].value;return e},sortPieData:function(t){var e=t.options.data.content,n=t.options.data.sortOrder;switch(n){case"none":break;case"random":e=i.shuffleArray(e);break;case"value-asc":e.sort(function(t,e){return t.value<e.value?-1:1});break;case"value-desc":e.sort(function(t,e){return t.value<e.value?1:-1});break;case"label-asc":e.sort(function(t,e){return t.label.toLowerCase()>e.label.toLowerCase()?1:-1});break;case"label-desc":e.sort(function(t,e){return t.label.toLowerCase()<e.label.toLowerCase()?1:-1})}return e},getPieTranslateCenter:function(t){return"translate("+t.x+","+t.y+")"},calculatePieCenter:function(t){var e=t.options.misc.pieCenterOffset,n=t.textComponents.title.exists&&"pie-center"!==t.options.header.location,o=t.textComponents.subtitle.exists&&"pie-center"!==t.options.header.location,i=t.options.misc.canvasPadding.top;n&&o?i+=t.textComponents.title.h+t.options.header.titleSubtitlePadding+t.textComponents.subtitle.h:n?i+=t.textComponents.title.h:o&&(i+=t.textComponents.subtitle.h);var a=0;t.textComponents.footer.exists&&(a=t.textComponents.footer.h+t.options.misc.canvasPadding.bottom);var s=(t.options.size.canvasWidth-t.options.misc.canvasPadding.left-t.options.misc.canvasPadding.right)/2+t.options.misc.canvasPadding.left,r=(t.options.size.canvasHeight-a-i)/2+i;s+=e.x,r+=e.y,t.pieCenter={x:s,y:r}},rotate:function(t,e,n,o,i){var a=Math.cos,s=Math.sin,r=(t-n)*a(i=i*Math.PI/180)-(e-o)*s(i)+n,l=(t-n)*s(i)+(e-o)*a(i)+o;return{x:r,y:l}},translate:function(t,e,n,o){var i=s.toRadians(o);return{x:t+n*Math.sin(i),y:e-n*Math.cos(i)}},pointIsInArc:function(t,e,n){var o=n.innerRadius()(e),i=n.outerRadius()(e),a=n.startAngle()(e),s=n.endAngle()(e),r=t.x*t.x+t.y*t.y,l=Math.atan2(t.x,-t.y);return l=l<0?l+2*Math.PI:l,o*o<=r&&r<=i*i&&a<=l&&l<=s}},r={add:function(t,e,n){var o=r.getIncludes(n),i=t.options.labels,a=t.svg.insert("g","."+t.cssPrefix+"labels-"+e).attr("class",t.cssPrefix+"labels-"+e).selectAll("."+t.cssPrefix+"labelGroup-"+e).data(t.options.data.content).enter().append("g").attr("id",function(n,o){return t.cssPrefix+"labelGroup"+o+"-"+e}).attr("data-index",function(t,e){return e}).attr("class",t.cssPrefix+"labelGroup-"+e).style("opacity",0),s={section:e,sectionDisplayType:n};o.mainLabel&&a.append("text").attr("id",function(n,o){return t.cssPrefix+"segmentMainLabel"+o+"-"+e}).attr("class",t.cssPrefix+"segmentMainLabel-"+e).html(function(t,e){var n=t.label;return i.formatter?(s.index=e,s.part="mainLabel",s.value=t.value,s.label=n,n=i.formatter(s)):i.truncation.enabled&&t.label.length>i.truncation.truncateLength&&(n=t.label.substring(0,i.truncation.truncateLength)+"..."),wrap(n,"mainLabel")}).style("font-size",i.mainLabel.fontSize+"px").style("font-family",i.mainLabel.font).style("fill",i.mainLabel.color),o.percentage&&a.append("text").attr("id",function(n,o){return t.cssPrefix+"segmentPercentage"+o+"-"+e}).attr("class",t.cssPrefix+"segmentPercentage-"+e).text(function(t,e){var n=t.percentage;return i.formatter?(s.index=e,s.part="percentage",s.value=t.value,s.label=t.percentage,n=i.formatter(s)):n+="%",n}).style("font-size",i.percentage.fontSize+"px").style("font-family",i.percentage.font).style("fill",i.percentage.color),o.value&&a.append("text").attr("id",function(n,o){return t.cssPrefix+"segmentValue"+o+"-"+e}).attr("class",t.cssPrefix+"segmentValue-"+e).text(function(t,e){return s.index=e,s.part="value",s.value=t.value,s.label=t.value,i.formatter?i.formatter(s,t.value):t.value}).style("font-size",i.value.fontSize+"px").style("font-family",i.value.font).style("fill",i.value.color)},positionLabelElements:function(t,e,n){r["dimensions-"+e]=[],d3.selectAll("."+t.cssPrefix+"labelGroup-"+e).each(function(n,o){var i=d3.select(this).selectAll("."+t.cssPrefix+"segmentMainLabel-"+e),a=d3.select(this).selectAll("."+t.cssPrefix+"segmentPercentage-"+e),s=d3.select(this).selectAll("."+t.cssPrefix+"segmentValue-"+e);r["dimensions-"+e].push({mainLabel:null!==i.node()?i.node().getBBox():null,percentage:null!==a.node()?a.node().getBBox():null,value:null!==s.node()?s.node().getBBox():null})});var o=r["dimensions-"+e];switch(n){case"label-value1":d3.selectAll("."+t.cssPrefix+"segmentValue-"+e).attr("dx",function(t,e){return o[e].mainLabel.width+5});break;case"label-value2":d3.selectAll("."+t.cssPrefix+"segmentValue-"+e).attr("dy",function(t,e){return o[e].mainLabel.height});break;case"label-percentage1":d3.selectAll("."+t.cssPrefix+"segmentPercentage-"+e).attr("dx",function(t,e){return o[e].mainLabel.width+5});break;case"label-percentage2":d3.selectAll("."+t.cssPrefix+"segmentPercentage-"+e).attr("dx",function(t,e){return o[e].mainLabel.width/2-o[e].percentage.width/2}).attr("dy",function(t,e){return o[e].mainLabel.height})}},computeLabelLinePositions:function(t){t.lineCoordGroups=[],d3.selectAll("."+t.cssPrefix+"labelGroup-outer").each(function(e,n){return r.computeLinePosition(t,n)})},computeLinePosition:function(t,e){var n,o,i,a,r=l.getSegmentAngle(e,t.options.data.content,t.totalSize,{midpoint:!0}),c=s.rotate(t.pieCenter.x,t.pieCenter.y-t.outerRadius,t.pieCenter.x,t.pieCenter.y,r),u=t.outerLabelGroupData[e].h/5,p=Math.floor(r/90);switch(2===p&&180===r&&(p=1),p){case 0:n=t.outerLabelGroupData[e].x-6-(t.outerLabelGroupData[e].x-6-c.x)/2,o=t.outerLabelGroupData[e].y+(c.y-t.outerLabelGroupData[e].y)/4,i=t.outerLabelGroupData[e].x-6,a=t.outerLabelGroupData[e].y-u;break;case 1:n=c.x+(t.outerLabelGroupData[e].x-c.x)/4,o=c.y+(t.outerLabelGroupData[e].y-c.y)/4,i=t.outerLabelGroupData[e].x-6,a=t.outerLabelGroupData[e].y-u;break;case 2:var f=t.outerLabelGroupData[e].x+t.outerLabelGroupData[e].w+6;n=c.x-(c.x-f)/4,o=c.y+(t.outerLabelGroupData[e].y-c.y)/4,i=t.outerLabelGroupData[e].x+t.outerLabelGroupData[e].w+6,a=t.outerLabelGroupData[e].y-u;break;case 3:var g=t.outerLabelGroupData[e].x+t.outerLabelGroupData[e].w+6;n=g+(c.x-g)/4,o=t.outerLabelGroupData[e].y+(c.y-t.outerLabelGroupData[e].y)/4,i=t.outerLabelGroupData[e].x+t.outerLabelGroupData[e].w+6,a=t.outerLabelGroupData[e].y-u}"straight"===t.options.labels.lines.style?t.lineCoordGroups[e]=[{x:c.x,y:c.y},{x:i,y:a}]:t.lineCoordGroups[e]=[{x:c.x,y:c.y},{x:n,y:o},{x:i,y:a}]},addLabelLines:function(t){var e=t.svg.insert("g","."+t.cssPrefix+"pieChart").attr("class",t.cssPrefix+"lineGroups").style("opacity",0).selectAll("."+t.cssPrefix+"lineGroup").data(t.lineCoordGroups).enter().append("g").attr("class",t.cssPrefix+"lineGroup"),n=d3.line().curve(d3.curveBasis).x(function(t){return t.x}).y(function(t){return t.y});e.append("path").attr("d",n).attr("stroke",function(e,n){return"segment"===t.options.labels.lines.color?t.options.colors[n]:t.options.labels.lines.color}).attr("stroke-width",1).attr("fill","none").style("opacity",function(e,n){var o=t.options.labels.outer.hideWhenLessThanPercentage;return null!==o&&e.percentage<o||""===t.options.data.content[n].label?0:1})},positionLabelGroups:function(t,e){"none"!==t.options.labels[e].format&&d3.selectAll("."+t.cssPrefix+"labelGroup-"+e).style("opacity",0).attr("transform",function(n,o){var r,c;if("outer"===e)r=t.outerLabelGroupData[o].x,c=t.outerLabelGroupData[o].y;else{var u=a(!0,{},t.pieCenter);if(t.innerRadius>0){var p=l.getSegmentAngle(o,t.options.data.content,t.totalSize,{midpoint:!0}),f=s.translate(t.pieCenter.x,t.pieCenter.y,t.innerRadius,p);u.x=f.x,u.y=f.y}var g=i.getDimensions(t.cssPrefix+"labelGroup"+o+"-inner"),h=g.w/2,b=g.h/4;r=u.x+(t.lineCoordGroups[o][0].x-u.x)/1.8,c=u.y+(t.lineCoordGroups[o][0].y-u.y)/1.8,r-=h,c+=b}return"translate("+r+","+c+")"})},fadeInLabelsAndLines:function(t){setTimeout(function(){var e="default"===t.options.effects.load.effect?400:1;d3.selectAll("."+t.cssPrefix+"labelGroup-outer").transition().duration(e).style("opacity",function(e,n){var o=t.options.labels.outer.hideWhenLessThanPercentage;return null!==o&&e.percentage<o?0:1}),d3.selectAll("."+t.cssPrefix+"labelGroup-inner").transition().duration(e).style("opacity",function(e,n){var o=t.options.labels.inner.hideWhenLessThanPercentage;return null!==o&&e.percentage<o?0:1}),d3.selectAll("g."+t.cssPrefix+"lineGroups").transition().duration(e).style("opacity",1),i.isFunction(t.options.callbacks.onload)&&setTimeout(function(){try{t.options.callbacks.onload()}catch(e){}},e)},"default"===t.options.effects.load.effect?t.options.effects.load.speed:1)},getIncludes:function(t){var e=!1,n=!1,o=!1;switch(t){case"label":e=!0;break;case"value":n=!0;break;case"percentage":o=!0;break;case"label-value1":case"label-value2":e=!0,n=!0;break;case"label-percentage1":case"label-percentage2":e=!0,o=!0}return{mainLabel:e,value:n,percentage:o}},computeOuterLabelCoords:function(t){t.svg.selectAll("."+t.cssPrefix+"labelGroup-outer").each(function(e,n){return r.getIdealOuterLabelPositions(t,n)}),r.resolveOuterLabelCollisions(t)},resolveOuterLabelCollisions:function(t){if("none"!==t.options.labels.outer.format){var e=t.options.data.content.length;r.checkConflict(t,0,"clockwise",e),r.checkConflict(t,e-1,"anticlockwise",e)}},checkConflict:function(t,e,n,o){if(!(o<=1)){var a,s,l=t.outerLabelGroupData[e].hs;if(("clockwise"!==n||"right"===l)&&("anticlockwise"!==n||"left"===l)){var c="clockwise"===n?e+1:e-1,u=t.outerLabelGroupData[e],p=t.outerLabelGroupData[c],f={labelHeights:t.outerLabelGroupData[0].h,center:t.pieCenter,lineLength:t.outerRadius+t.options.labels.outer.pieDistance,heightChange:t.outerLabelGroupData[0].h+1};if("clockwise"===n){for(a=0;a<=e;a++)if(s=t.outerLabelGroupData[a],!r.isLabelHidden(t,a)&&i.rectIntersect(s,p)){r.adjustLabelPos(t,c,u,f);break}}else for(a=o-1;a>=e;a--)if(s=t.outerLabelGroupData[a],!r.isLabelHidden(t,a)&&i.rectIntersect(s,p)){r.adjustLabelPos(t,c,u,f);break}r.checkConflict(t,c,n,o)}}},isLabelHidden:function(t,e){var n=t.options.labels.outer.hideWhenLessThanPercentage;return null!==n&&d.percentage<n||""===t.options.data.content[e].label},adjustLabelPos:function(t,e,n,o){var i,a,s,r;r=n.y+o.heightChange,a=o.center.y-r,i=Math.abs(o.lineLength)>Math.abs(a)?Math.sqrt(o.lineLength*o.lineLength-a*a):Math.sqrt(a*a-o.lineLength*o.lineLength),s="right"===n.hs?o.center.x+i:o.center.x-i-t.outerLabelGroupData[e].w,t.outerLabelGroupData[e].x=s,t.outerLabelGroupData[e].y=r},getIdealOuterLabelPositions:function(t,e){var n=d3.select("#"+t.cssPrefix+"labelGroup"+e+"-outer").node();if(n){var o=n.getBBox(),i=l.getSegmentAngle(e,t.options.data.content,t.totalSize,{midpoint:!0}),a=t.pieCenter.x,r=t.pieCenter.y-(t.outerRadius+t.options.labels.outer.pieDistance),c=s.rotate(a,r,t.pieCenter.x,t.pieCenter.y,i),u="right";i>180?(c.x-=o.width+8,u="left"):c.x+=8,t.outerLabelGroupData[e]={x:c.x,y:c.y,w:o.width,h:o.height,hs:u}}}},l={effectMap:{none:d3.easeLinear,bounce:d3.easeBounce,linear:d3.easeLinear,sin:d3.easeSin,elastic:d3.easeElastic,back:d3.easeBack,quad:d3.easeQuad,circle:d3.easeCircle,exp:d3.easeExp},create:function(t){var e=t.pieCenter,n=t.options.colors,o=t.options.effects.load,i=t.options.misc.colors.segmentStroke,a=t.svg.insert("g","#"+t.cssPrefix+"title").attr("transform",function(){return s.getPieTranslateCenter(e)}).attr("class",t.cssPrefix+"pieChart"),r=d3.arc().innerRadius(t.innerRadius).outerRadius(t.outerRadius).startAngle(0).endAngle(function(e){return e.value/t.totalSize*2*Math.PI}),c=a.selectAll("."+t.cssPrefix+"arc").data(t.options.data.content).enter().append("g").attr("class",t.cssPrefix+"arc"),u=o.speed;"none"===o.effect&&(u=0),c.append("path").attr("id",function(e,n){return t.cssPrefix+"segment"+n}).attr("fill",function(e,o){var i=n[o];return t.options.misc.gradient.enabled&&(i="url(#"+t.cssPrefix+"grad"+o+")"),i}).style("stroke",i).style("stroke-width",1).transition().ease(d3.easeCubicInOut).duration(u).attr("data-index",function(t,e){return e}).attrTween("d",function(e){var n=d3.interpolate({value:0},e);return function(e){return t.arc(n(e))}}),t.svg.selectAll("g."+t.cssPrefix+"arc").attr("transform",function(e,n){var o=0;return n>0&&(o=l.getSegmentAngle(n-1,t.options.data.content,t.totalSize)),"rotate("+o+")"}),t.arc=r},addGradients:function(t){var e=t.svg.append("defs").selectAll("radialGradient").data(t.options.data.content).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",0).attr("cy",0).attr("r","120%").attr("id",function(e,n){return t.cssPrefix+"grad"+n});e.append("stop").attr("offset","0%").style("stop-color",function(e,n){return t.options.colors[n]}),e.append("stop").attr("offset",t.options.misc.gradient.percentage+"%").style("stop-color",t.options.misc.gradient.color)},addSegmentEventHandlers:function(t){var e=d3.selectAll("."+t.cssPrefix+"arc,."+t.cssPrefix+"labelGroup-inner,."+t.cssPrefix+"labelGroup-outer");e.on("click",function(){var e,n=d3.select(this);if(n.attr("class")===t.cssPrefix+"arc")e=n.select("path");else{var o=n.attr("data-index");e=d3.select("#"+t.cssPrefix+"segment"+o)}var i=e.attr("class")===t.cssPrefix+"expanded";l.onSegmentEvent(t,t.options.callbacks.onClickSegment,e,i),"none"!==t.options.effects.pullOutSegmentOnClick.effect&&(i?l.closeSegment(t,e.node()):l.openSegment(t,e.node()))}),e.on("mouseover",function(){var e,n,o=d3.select(this);if(o.attr("class")===t.cssPrefix+"arc"?e=o.select("path"):(n=o.attr("data-index"),e=d3.select("#"+t.cssPrefix+"segment"+n)),t.options.effects.highlightSegmentOnMouseover){n=e.attr("data-index");var a=t.options.colors[n];e.style("fill",i.getColorShade(a,t.options.effects.highlightLuminosity))}t.options.tooltips.enabled&&(n=e.attr("data-index"),u.showTooltip(t,n));var s=e.attr("class")===t.cssPrefix+"expanded";l.onSegmentEvent(t,t.options.callbacks.onMouseoverSegment,e,s)}),e.on("mousemove",function(){u.moveTooltip(t)}),e.on("mouseout",function(){var e,n,o=d3.select(this);if(o.attr("class")===t.cssPrefix+"arc"?e=o.select("path"):(n=o.attr("data-index"),e=d3.select("#"+t.cssPrefix+"segment"+n)),t.options.effects.highlightSegmentOnMouseover){n=e.attr("data-index");var i=t.options.colors[n];t.options.misc.gradient.enabled&&(i="url(#"+t.cssPrefix+"grad"+n+")"),e.style("fill",i)}t.options.tooltips.enabled&&(n=e.attr("data-index"),u.hideTooltip(t,n));var a=e.attr("class")===t.cssPrefix+"expanded";l.onSegmentEvent(t,t.options.callbacks.onMouseoutSegment,e,a)})},onSegmentEvent:function(t,e,n,o){if(i.isFunction(e)){var a=parseInt(n.attr("data-index"),10);e({segment:n.node(),index:a,expanded:o,data:t.options.data.content[a]})}},openSegment:function(t,e){!t.isOpeningSegment&&(t.isOpeningSegment=!0,l.maybeCloseOpenSegment(),d3.select(e).transition().ease(l.effectMap[t.options.effects.pullOutSegmentOnClick.effect]).duration(t.options.effects.pullOutSegmentOnClick.speed).attr("transform",function(e,n){var o=t.arc.centroid(e),i=o[0],a=o[1],s=Math.sqrt(i*i+a*a),r=parseInt(t.options.effects.pullOutSegmentOnClick.size,10);return"translate("+i/s*r+","+a/s*r+")"}).on("end",function(n,o){t.currentlyOpenSegment=e,t.isOpeningSegment=!1,d3.select(e).attr("class",t.cssPrefix+"expanded")}))},maybeCloseOpenSegment:function(){d3.selectAll("."+pie.cssPrefix+"expanded").size()>0&&l.closeSegment(pie,d3.select("."+pie.cssPrefix+"expanded").node())},closeSegment:function(t,e){d3.select(e).transition().duration(400).attr("transform","translate(0,0)").on("end",function(n,o){d3.select(e).attr("class",""),t.currentlyOpenSegment=null})},getCentroid:function(t){var e=t.getBBox();return{x:e.x+e.width/2,y:e.y+e.height/2}},getSegmentAngle:function(t,e,n,o){var i,s=a({compounded:!0,midpoint:!1},o),r=e[t].value;if(s.compounded){i=0;for(var l=0;l<=t;l++)i+=e[l].value}void 0===i&&(i=r);var c=i/n*360;return s.midpoint&&(c-=r/n*360/2),c}},c={offscreenCoord:-1e4,addTitle:function(t){t.svg.selectAll("."+t.cssPrefix+"title").data([t.options.header.title]).enter().append("text").text(function(t){return t.text}).attr("id",t.cssPrefix+"title").attr("class",t.cssPrefix+"title").attr("x",c.offscreenCoord).attr("y",c.offscreenCoord).attr("text-anchor",function(){var e;return"top-center"===t.options.header.location||"pie-center"===t.options.header.location?"middle":"left"}).attr("fill",function(t){return t.color}).style("font-size",function(t){return t.fontSize+"px"}).style("font-family",function(t){return t.font})},positionTitle:function(t){var e,n=t.textComponents,o=t.options.header.location,i=t.options.misc.canvasPadding,a=t.options.size.canvasWidth,s=t.options.header.titleSubtitlePadding;e="top-left"===o?i.left:(a-i.right)/2+i.left,e+=t.options.misc.pieCenterOffset.x;var r=i.top+n.title.h;"pie-center"===o&&((r=t.pieCenter.y,n.subtitle.exists)?r=r-(n.title.h+s+n.subtitle.h)/2+n.title.h:r+=n.title.h/4),t.svg.select("#"+t.cssPrefix+"title").attr("x",e).attr("y",r)},addSubtitle:function(t){var e=t.options.header.location;t.svg.selectAll("."+t.cssPrefix+"subtitle").data([t.options.header.subtitle]).enter().append("text").text(function(t){return t.text}).attr("x",c.offscreenCoord).attr("y",c.offscreenCoord).attr("id",t.cssPrefix+"subtitle").attr("class",t.cssPrefix+"subtitle").attr("text-anchor",function(){var t;return"top-center"===e||"pie-center"===e?"middle":"left"}).attr("fill",function(t){return t.color}).style("font-size",function(t){return t.fontSize+"px"}).style("font-family",function(t){return t.font})},positionSubtitle:function(t){var e,n=t.options.misc.canvasPadding,o=t.options.size.canvasWidth;e="top-left"===t.options.header.location?n.left:(o-n.right)/2+n.left,e+=t.options.misc.pieCenterOffset.x;var i=c.getHeaderHeight(t);t.svg.select("#"+t.cssPrefix+"subtitle").attr("x",e).attr("y",i)},addFooter:function(t){t.svg.selectAll("."+t.cssPrefix+"footer").data([t.options.footer]).enter().append("text").text(function(t){return t.text}).attr("x",c.offscreenCoord).attr("y",c.offscreenCoord).attr("id",t.cssPrefix+"footer").attr("class",t.cssPrefix+"footer").attr("text-anchor",function(){var e="left";return"bottom-center"===t.options.footer.location?e="middle":"bottom-right"===t.options.footer.location&&(e="left"),e}).attr("fill",function(t){return t.color}).style("font-size",function(t){return t.fontSize+"px"}).style("font-family",function(t){return t.font})},positionFooter:function(t){var e,n=t.options.footer.location,o=t.textComponents.footer.w,i=t.options.size.canvasWidth,a=t.options.size.canvasHeight,s=t.options.misc.canvasPadding;e="bottom-left"===n?s.left:"bottom-right"===n?i-o-s.right:i/2,t.svg.select("#"+t.cssPrefix+"footer").attr("x",e).attr("y",a-s.bottom)},getHeaderHeight:function(t){var e;if(t.textComponents.title.exists){var n=t.textComponents.title.h+t.options.header.titleSubtitlePadding+t.textComponents.subtitle.h;e="pie-center"===t.options.header.location?t.pieCenter.y-n/2+n:n+t.options.misc.canvasPadding.top}else if("pie-center"===t.options.header.location){var o=t.options.misc.canvasPadding.bottom+t.textComponents.footer.h;e=(t.options.size.canvasHeight-o)/2+t.options.misc.canvasPadding.top+t.textComponents.subtitle.h/2}else e=t.options.misc.canvasPadding.top+t.textComponents.subtitle.h;return e}},u={addTooltips:function(t){var e=t.svg.insert("g").attr("class",t.cssPrefix+"tooltips");e.selectAll("."+t.cssPrefix+"tooltip").data(t.options.data.content).enter().append("g").attr("class",t.cssPrefix+"tooltip").attr("id",function(e,n){return t.cssPrefix+"tooltip"+n}).style("opacity",0).append("rect").attr("rx",t.options.tooltips.styles.borderRadius).attr("ry",t.options.tooltips.styles.borderRadius).attr("x",-t.options.tooltips.styles.padding).attr("opacity",t.options.tooltips.styles.backgroundOpacity).style("fill",t.options.tooltips.styles.backgroundColor),e.selectAll("."+t.cssPrefix+"tooltip").data(t.options.data.content).append("text").attr("fill",function(e){return t.options.tooltips.styles.color}).style("font-size",function(e){return t.options.tooltips.styles.fontSize}).style("font-family",function(e){return t.options.tooltips.styles.font}).html(function(e,n){var o=t.options.tooltips.string;return"caption"===t.options.tooltips.type&&(o=wrap(e.caption,"caption")),u.replacePlaceholders(t,o,n,{label:e.label,value:e.value,percentage:e.percentage})}),e.selectAll("."+t.cssPrefix+"tooltip rect").attr("width",function(e,n){return i.getDimensions(t.cssPrefix+"tooltip"+n).w+2*t.options.tooltips.styles.padding}).attr("height",function(e,n){return i.getDimensions(t.cssPrefix+"tooltip"+n).h+2*t.options.tooltips.styles.padding}).attr("y",function(e,n){return-(i.getDimensions(t.cssPrefix+"tooltip"+n).h/2)+1})},showTooltip:function(t,e){var n=t.options.tooltips.styles.fadeInSpeed;u.currentTooltip===e&&(n=1),u.currentTooltip=e,d3.select("#"+t.cssPrefix+"tooltip"+e).transition().duration(n).style("opacity",function(){return 1}),u.moveTooltip(t)},moveTooltip:function(t){d3.selectAll("#"+t.cssPrefix+"tooltip"+u.currentTooltip).attr("transform",function(e){var n,o=d3.mouse(this.parentNode);return"translate("+(o[0]+t.options.tooltips.styles.padding+2)+","+(o[1]-2*t.options.tooltips.styles.padding-2)+")"})},hideTooltip:function(t,e){d3.select("#"+t.cssPrefix+"tooltip"+e).style("opacity",function(){return 0}),d3.select("#"+t.cssPrefix+"tooltip"+u.currentTooltip).attr("transform",function(e,n){var o;return"translate("+(t.options.size.canvasWidth+1e3)+","+(t.options.size.canvasHeight+1e3)+")"})},replacePlaceholders:function(t,e,n,o){return i.isFunction(t.options.tooltips.placeholderParser)&&t.options.tooltips.placeholderParser(n,o),e.replace(/\{(\w+)\}/g,function(t){var e=arguments[1];return o.hasOwnProperty(e)?o[arguments[1]]:arguments[0]})}},p=function(i,s){if(this.element=i,"string"==typeof i){var r=i.replace(/^#/,"");this.element=document.getElementById(r)}var l={};a(!0,l,n,s),this.options=l,null!==this.options.misc.cssPrefix?this.cssPrefix=this.options.misc.cssPrefix:(this.cssPrefix="p"+e+"_",e++),o.initialCheck(this)&&(d3.select(this.element).attr(t,"0.2.1"),f.call(this),g.call(this))};p.prototype.recreate=function(){o.initialCheck(this)&&(f.call(this),g.call(this))},p.prototype.redraw=function(){this.element.innerHTML="",g.call(this)},p.prototype.destroy=function(){this.element.innerHTML="",d3.select(this.element).attr(t,null)},p.prototype.getOpenSegment=function(){var t=this.currentlyOpenSegment;if(null==t)return null;var e=parseInt(d3.select(t).attr("data-index"),10);return{element:t,index:e,data:this.options.data.content[e]}},p.prototype.openSegment=function(t){!((t=parseInt(t,10))<0)&&!(t>this.options.data.content.length-1)&&l.openSegment(this,d3.select("#"+this.cssPrefix+"segment"+t).node())},p.prototype.closeSegment=function(){l.maybeCloseOpenSegment()},p.prototype.updateProp=function(t,e){switch(t){case"header.title.text":var n=i.processObj(this.options,t);i.processObj(this.options,t,e),d3.select("#"+this.cssPrefix+"title").html(e),(""===n&&""!==e||""!==n&&""===e)&&this.redraw();break;case"header.subtitle.text":var o=i.processObj(this.options,t);i.processObj(this.options,t,e),d3.select("#"+this.cssPrefix+"subtitle").html(e),(""===o&&""!==e||""!==o&&""===e)&&this.redraw();break;case"callbacks.onload":case"callbacks.onMouseoverSegment":case"callbacks.onMouseoutSegment":case"callbacks.onClickSegment":case"effects.pullOutSegmentOnClick.effect":case"effects.pullOutSegmentOnClick.speed":case"effects.pullOutSegmentOnClick.size":case"effects.highlightSegmentOnMouseover":case"effects.highlightLuminosity":i.processObj(this.options,t,e);break;default:i.processObj(this.options,t,e),this.destroy(),this.recreate()}};var f=function(){this.options.data.content=s.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=i.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=i.initSegmentColors(this),this.totalSize=s.getTotalPieSize(this.options.data.content);for(var t=this.options.labels.percentage.decimalPlaces,e=0;e<this.options.data.content.length;e++)this.options.data.content[e].percentage=h(this.options.data.content[e].value,this.totalSize,t);for(var n=0,o=0;o<this.options.data.content.length;o++)o===this.options.data.content.length-1&&(this.options.data.content[o].percentage=(100-n).toFixed(t)),n+=parseFloat(this.options.data.content[o].percentage)},g=function(){this.svg=i.addSVGSpace(this),this.textComponents={headerHeight:0,title:{exists:""!==this.options.header.title.text,h:0,w:0},subtitle:{exists:""!==this.options.header.subtitle.text,h:0,w:0},footer:{exists:""!==this.options.footer.text,h:0,w:0}},this.outerLabelGroupData=[],this.textComponents.title.exists&&c.addTitle(this),this.textComponents.subtitle.exists&&c.addSubtitle(this),c.addFooter(this);var t=this;i.whenIdExists(this.cssPrefix+"footer",function(){c.positionFooter(t);var e=i.getDimensions(t.cssPrefix+"footer");t.textComponents.footer.h=e.h,t.textComponents.footer.w=e.w});var e=[];this.textComponents.title.exists&&e.push(this.cssPrefix+"title"),this.textComponents.subtitle.exists&&e.push(this.cssPrefix+"subtitle"),this.textComponents.footer.exists&&e.push(this.cssPrefix+"footer"),i.whenElementsExist(e,function(){if(t.textComponents.title.exists){var e=i.getDimensions(t.cssPrefix+"title");t.textComponents.title.h=e.h,t.textComponents.title.w=e.w}if(t.textComponents.subtitle.exists){var n=i.getDimensions(t.cssPrefix+"subtitle");t.textComponents.subtitle.h=n.h,t.textComponents.subtitle.w=n.w}if(t.textComponents.title.exists||t.textComponents.subtitle.exists){var o=0;t.textComponents.title.exists&&(o+=t.textComponents.title.h,t.textComponents.subtitle.exists&&(o+=t.options.header.titleSubtitlePadding)),t.textComponents.subtitle.exists&&(o+=t.textComponents.subtitle.h),t.textComponents.headerHeight=o}s.computePieRadius(t),s.calculatePieCenter(t),c.positionTitle(t),c.positionSubtitle(t),t.options.misc.gradient.enabled&&l.addGradients(t),l.create(t),r.add(t,"inner",t.options.labels.inner.format),r.add(t,"outer",t.options.labels.outer.format),r.positionLabelElements(t,"inner",t.options.labels.inner.format),r.positionLabelElements(t,"outer",t.options.labels.outer.format),r.computeOuterLabelCoords(t),r.positionLabelGroups(t,"outer"),r.computeLabelLinePositions(t),t.options.labels.lines.enabled&&"none"!==t.options.labels.outer.format&&r.addLabelLines(t),r.positionLabelGroups(t,"inner"),r.fadeInLabelsAndLines(t),t.options.tooltips.enabled&&u.addTooltips(t),l.addSegmentEventHandlers(t)})},h=function(t,e,n){var o=t/e;return n<=0?Math.round(100*o):(100*o).toFixed(n)};return p});